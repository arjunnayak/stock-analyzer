name: Daily Backfill from Queue

on:
  # schedule:
  #   # Run daily at 2 AM UTC (before market data evaluation at 6 PM ET)
  #   # DISABLED: Run manually only via workflow_dispatch
  #   - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.10'

jobs:
  process-backfill-queue:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: prod-actions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Process backfill queue
        env:
          ENV: REMOTE
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
        run: |
          uv run python scripts/process_backfill_queue.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backfill-logs-${{ github.run_number }}
          path: logs/backfill-*.log
          retention-days: 7

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Daily Backfill Failed',
              body: `Daily backfill job failed.\n\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'automated']
            })
