name: Daily Pipeline

# End-of-day workflow that:
# 1. Ingests latest prices from EODHD (creates price snapshot)
# 2. Computes daily features (EMA, EV/EBITDA) to wide features table
# 3. Evaluates hardcoded templates and stores triggers
on:
  schedule:
    # Run at 11 PM UTC daily (6 PM ET)
    - cron: '0 23 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      tickers:
        description: 'Specific tickers to process (space-separated, leave empty for all watchlist)'
        required: false
        default: ''
      skip_ingestion:
        description: 'Skip price ingestion step (use existing data)'
        required: false
        type: boolean
        default: false
      skip_features:
        description: 'Skip feature computation step'
        required: false
        type: boolean
        default: false
      skip_templates:
        description: 'Skip template evaluation step'
        required: false
        type: boolean
        default: false
      run_date:
        description: 'Run date override (YYYY-MM-DD, defaults to today)'
        required: false
        default: ''

jobs:
  daily-pipeline:
    name: EOD Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: prod-actions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      # ===================================================================
      # STEP 1: Ingest Latest Prices from EODHD
      # ===================================================================
      - name: 1. Ingest latest prices
        if: ${{ !inputs.skip_ingestion }}
        env:
          ENV: REMOTE
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
        run: |
          echo "======================================================================"
          echo "STEP 1: Ingesting Latest Prices"
          echo "======================================================================"

          if [ -n "${{ github.event.inputs.tickers }}" ]; then
            uv run python scripts/ingest_prices.py --tickers ${{ github.event.inputs.tickers }} --days 7
          else
            uv run python scripts/ingest_prices.py --watchlist --days 7
          fi

      # ===================================================================
      # STEP 2: Compute Daily Features (EMA, EV/EBITDA) to Wide Table
      # ===================================================================
      - name: 2. Compute daily features
        if: ${{ !inputs.skip_features }}
        env:
          ENV: REMOTE
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "======================================================================"
          echo "STEP 2: Computing Daily Features"
          echo "======================================================================"

          # Determine run date
          RUN_DATE="${{ github.event.inputs.run_date }}"
          if [ -z "$RUN_DATE" ]; then
            RUN_DATE=$(date +%Y-%m-%d)
          fi

          # Build args
          ARGS="--run-date $RUN_DATE"
          if [ -n "${{ github.event.inputs.tickers }}" ]; then
            ARGS="$ARGS --tickers ${{ github.event.inputs.tickers }}"
          fi

          echo "Running: python -m src.features.pipeline_daily $ARGS --skip-templates"
          uv run python -m src.features.pipeline_daily $ARGS --skip-templates

      # ===================================================================
      # STEP 3: Evaluate Hardcoded Templates
      # ===================================================================
      - name: 3. Evaluate templates
        if: ${{ !inputs.skip_templates }}
        env:
          ENV: REMOTE
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "======================================================================"
          echo "STEP 3: Evaluating Hardcoded Templates"
          echo "======================================================================"

          # Determine run date
          RUN_DATE="${{ github.event.inputs.run_date }}"
          if [ -z "$RUN_DATE" ]; then
            RUN_DATE=$(date +%Y-%m-%d)
          fi

          echo "Running: python -m src.features.pipeline_daily --run-date $RUN_DATE --skip-features"
          uv run python -m src.features.pipeline_daily --run-date $RUN_DATE --skip-features

      # ===================================================================
      # Artifacts and Notifications
      # ===================================================================
      - name: Upload pipeline logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-pipeline-logs-${{ github.run_number }}
          path: |
            logs/*.log
            *.log
          retention-days: 7

      - name: Report pipeline success
        if: success()
        run: |
          echo "======================================================================"
          echo "✅ Daily Pipeline Completed Successfully"
          echo "======================================================================"
          echo "All steps completed:"
          echo "  ✓ Price data ingested"
          echo "  ✓ Daily features computed (EMA, EV/EBITDA)"
          echo "  ✓ Hardcoded templates evaluated"

      - name: Notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '[ALERT] Daily Pipeline Failed'
          to: ${{ secrets.ALERT_EMAIL }}
          from: Material Changes Alerts <noreply@materialchanges.app>
          body: |
            The daily pipeline job failed.

            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Time: ${{ github.event.head_commit.timestamp }}

            This may affect alert delivery. Investigate immediately.
